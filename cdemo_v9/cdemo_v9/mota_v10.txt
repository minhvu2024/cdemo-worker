ğŸ“˜ Äáº¶C Táº¢ CHI TIáº¾T Dá»° ÃN BIN DATABASE SYSTEM - V9
ğŸ“… Cáº­p nháº­t: 2025-12-16
Quan trá»ng: Ä‘Ã¢y lÃ  file khÃ´ng Ä‘Æ°á»£c xÃ³a ná»™i dung, chá»‰ Ä‘Æ°á»£c phÃ©p ghi thÃªm

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. Tá»”NG QUAN Dá»° ÃN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1.1. MÃ´ táº£
Há»‡ thá»‘ng quáº£n lÃ½ vÃ  tra cá»©u thÃ´ng tin tháº» tÃ­n dá»¥ng/ghi ná»£, xÃ¢y dá»±ng trÃªn:
- Backend: Cloudflare Workers (JavaScript, Edge Runtime)
- Database: Cloudflare D1 (SQLite)
- Storage: ~1.2GB
- API: RESTful JSON
- Frontend: Single Page Application (SPA) vá»›i HTML/CSS/JavaScript

1.2. Má»¥c tiÃªu
âœ… Quáº£n lÃ½ 10 triá»‡u tháº» + 400k BIN toÃ n cáº§u
âœ… Tra cá»©u BIN nhanh (<50ms)
âœ… Export tháº» theo filter Ä‘á»™ng (<2s cho 100 BINs)
âœ… Dashboard real-time (<100ms)
âœ… Import/Check duplicates hiá»‡u quáº£ (<5s cho 10k tháº»)

1.3. Quy mÃ´ dá»¯ liá»‡u
- Tháº» (cards):        10,000,000 rows
- BIN toÃ n cáº§u:       400,000 rows (BIN_Data)
- BIN cÃ³ tháº»:         65,648 rows (bin_inventory)
- Country groups:     ~10,000 rows (country_stats)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
2. Cáº¤U TRÃšC DATABASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

2.1. Tá»•ng sá»‘ báº£ng: 4

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   TÃªn báº£ng     â”‚   Rows    â”‚   Storage   â”‚   Má»¥c Ä‘Ã­ch       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cdata          â”‚ 10,000,000â”‚    ~1 GB    â”‚ LÆ°u tháº» gá»‘c      â”‚
â”‚ BIN_Data       â”‚   400,000 â”‚   ~50 MB    â”‚ Metadata BIN     â”‚
â”‚ bin_inventory  â”‚    65,648 â”‚   ~10 MB    â”‚ Stats pre-agg    â”‚
â”‚ country_stats  â”‚    ~10,000â”‚    ~2 MB    â”‚ Stats by country â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2.2. Báº£ng cdata (Card Data)
Má»¥c Ä‘Ã­ch: LÆ°u trá»¯ toÃ n bá»™ thÃ´ng tin tháº» gá»‘c

Cáº¥u trÃºc:
CREATE TABLE cdata(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    pan TEXT NOT NULL UNIQUE,              -- Primary Account Number (13-19 digits)
    mm TEXT NOT NULL,                      -- ThÃ¡ng háº¿t háº¡n (01-12)
    yy TEXT NOT NULL,                      -- NÄƒm háº¿t háº¡n (2 digits)
    cvv TEXT NOT NULL,                     -- CVV/CVC (3-4 digits)
    Bin TEXT NOT NULL,                     -- 6 sá»‘ Ä‘áº§u cá»§a PAN
    last4 TEXT NOT NULL,                   -- 4 sá»‘ cuá»‘i cá»§a PAN
    status TEXT NOT NULL DEFAULT 'unknown', -- '0'=die, '1'=live, '2'=ct, 'unknown'
    info TEXT NULL,                         -- ThÃ´ng tin bá»• sung
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);

RÃ ng buá»™c:
- pan: UNIQUE (khÃ´ng trÃ¹ng láº·p)
- mm: 01-12
- yy: 2 chá»¯ sá»‘
- cvv: 3-4 chá»¯ sá»‘
- Bin: 6 chá»¯ sá»‘
- last4: 4 chá»¯ sá»‘

Index:
- sqlite_autoindex_cdata_1 (tá»± Ä‘á»™ng): pan (tá»« UNIQUE constraint)
- idx_cdata_bin_status: (Bin, status) - Composite index cho query theo BIN vÃ  status
- idx_cdata_pan: pan - Index cho duplicate check
- idx_cdata_yy_mm: (yy, mm) - Index cho filter expired cards

2.3. Báº£ng BIN_Data (BIN Metadata)
Má»¥c Ä‘Ã­ch: LÆ°u metadata cá»§a 400k BIN toÃ n cáº§u

Cáº¥u trÃºc:
CREATE TABLE BIN_Data(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    BIN TEXT NOT NULL UNIQUE,              -- 6 chá»¯ sá»‘ BIN
    Brand TEXT,                            -- VISA, MASTERCARD, AMEX, DISCOVER...
    Type TEXT,                             -- DEBIT, CREDIT, PREPAID...
    Category TEXT,                         -- CLASSIC, GOLD, PLATINUM, BUSINESS...
    Issuer TEXT,                           -- TÃªn ngÃ¢n hÃ ng phÃ¡t hÃ nh
    isoCode2 TEXT,                         -- MÃ£ quá»‘c gia (US, GB, VN...)
    isoCode3 TEXT,                         -- MÃ£ quá»‘c gia 3 kÃ½ tá»±
    CountryName TEXT                       -- TÃªn quá»‘c gia Ä‘áº§y Ä‘á»§
);

Index:
- sqlite_autoindex_bindata_1 (tá»± Ä‘á»™ng): BIN (tá»« UNIQUE constraint)
- idx_bindata_brand_type_cat_country: (Brand, Type, Category, isoCode2) - Composite index cho filter queries

2.4. Báº£ng bin_inventory (BIN Inventory Stats)
Má»¥c Ä‘Ã­ch: Pre-aggregated stats cho má»—i BIN cÃ³ tháº» (denormalized)

Cáº¥u trÃºc:
CREATE TABLE bin_inventory (
    Bin TEXT PRIMARY KEY,
    -- Metadata (denormalized tá»« BIN_Data)
    Brand TEXT NOT NULL DEFAULT 'UNKNOWN',
    Type TEXT NOT NULL DEFAULT 'UNKNOWN',
    Category TEXT NOT NULL DEFAULT 'UNKNOWN',
    isoCode2 TEXT NOT NULL DEFAULT 'XX',
    Issuer TEXT NOT NULL DEFAULT 'UNKNOWN',
    CountryName TEXT,
    -- Statistics (pre-aggregated)
    total_cards INTEGER NOT NULL DEFAULT 0,
    live_cards INTEGER NOT NULL DEFAULT 0,
    ct_cards INTEGER NOT NULL DEFAULT 0,
    die_cards INTEGER NOT NULL DEFAULT 0,
    unknown_cards INTEGER NOT NULL DEFAULT 0,
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s','now'))
);

Index:
- PRIMARY KEY: Bin
- idx_bininv_country_brand: (isoCode2, Brand) - Cho filter theo country vÃ  brand
- idx_bininv_brand_type: (Brand, Type) - Cho filter theo brand vÃ  type
- idx_bininv_category: Category - Cho filter theo category
- idx_bininv_total: total_cards DESC - Cho Top BINs query

LÆ°u Ã½:
- Denormalized: Metadata Ä‘Æ°á»£c copy tá»« BIN_Data Ä‘á»ƒ trÃ¡nh JOIN runtime
- Pre-aggregated: Stats Ä‘Æ°á»£c tÃ­nh sáºµn tá»« cdata Ä‘á»ƒ query nhanh
- Chá»‰ lÆ°u BINs cÃ³ tháº» trong database (65,648 BINs)

2.5. Báº£ng country_stats (Country Statistics)
Má»¥c Ä‘Ã­ch: Pre-aggregated stats theo country, brand, type, category, issuer

Cáº¥u trÃºc:
CREATE TABLE country_stats (
    isoCode2 TEXT NOT NULL,
    Brand TEXT NOT NULL,
    Type TEXT NOT NULL,
    Category TEXT NOT NULL,
    Issuer TEXT NOT NULL,
    total_cards INTEGER NOT NULL DEFAULT 0,
    live_cards INTEGER NOT NULL DEFAULT 0,
    ct_cards INTEGER NOT NULL DEFAULT 0,
    die_cards INTEGER NOT NULL DEFAULT 0,
    unknown_cards INTEGER NOT NULL DEFAULT 0,
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s','now')),
    PRIMARY KEY (isoCode2, Brand, Type, Category, Issuer)
);

Index:
- PRIMARY KEY: (isoCode2, Brand, Type, Category, Issuer) - Composite primary key

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
3. CÃC CÃ‚U QUERY Tá»I Æ¯U
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

3.1. Dashboard Stats Query
Má»¥c Ä‘Ã­ch: Láº¥y thá»‘ng kÃª tá»•ng quan cho Dashboard

Query:
SELECT SUM(total_cards) as totalCards, COUNT(*) as totalRecords 
FROM bin_inventory

Giáº£i thÃ­ch:
- Query tá»« bin_inventory (pre-aggregated) thay vÃ¬ cdata (10M rows)
- KhÃ´ng cáº§n JOIN, khÃ´ng cáº§n GROUP BY
- Thá»i gian: <50ms

3.2. Top 10 Brands Query
Má»¥c Ä‘Ã­ch: Láº¥y top 10 brands theo sá»‘ lÆ°á»£ng tháº»

Query:
SELECT Brand as brand, SUM(total_cards) as count 
FROM bin_inventory 
GROUP BY Brand 
ORDER BY count DESC 
LIMIT 10

Giáº£i thÃ­ch:
- Query tá»« bin_inventory (65k rows) thay vÃ¬ cdata (10M rows)
- GROUP BY trÃªn báº£ng nhá» hÆ¡n 150 láº§n
- Thá»i gian: <30ms

3.3. Search BINs Query (Card Exporter)
Má»¥c Ä‘Ã­ch: TÃ¬m BINs theo filter Ä‘á»™ng

Query:
SELECT Bin, Brand, Type, Category, isoCode2, Issuer, total_cards, live_cards
FROM bin_inventory
WHERE Brand = ? AND Type = ? AND Category = ? AND isoCode2 = ? 
  AND Issuer LIKE ? AND total_cards >= ?
  AND (live_cards > 0 OR ct_cards > 0 OR unknown_cards > 0)
ORDER BY total_cards DESC
LIMIT ?

Giáº£i thÃ­ch:
- Query tá»« bin_inventory (denormalized) - khÃ´ng cáº§n JOIN vá»›i BIN_Data
- Sá»­ dá»¥ng index idx_bininv_brand_type, idx_bininv_category, idx_bininv_country_brand
- Filter status báº±ng cÃ¡ch check live_cards, ct_cards, die_cards, unknown_cards
- Thá»i gian: <100ms cho 10k BINs

3.4. Export Cards Query
Má»¥c Ä‘Ã­ch: Export cards tá»« nhiá»u BINs vá»›i random selection

Query:
WITH RankedCards AS (
  SELECT c.pan, c.mm, c.yy, c.cvv, c.Bin, c.info,
    ROW_NUMBER() OVER (PARTITION BY c.Bin ORDER BY RANDOM()) as rn
  FROM cdata c
  WHERE c.Bin IN (?, ?, ...) AND c.status IN (?, ?, ?)
)
SELECT pan, mm, yy, cvv, Bin, info
FROM RankedCards
WHERE rn <= ?
ORDER BY Bin, rn

Giáº£i thÃ­ch:
- Sá»­ dá»¥ng CTE (Common Table Expression) vá»›i ROW_NUMBER() vÃ  RANDOM()
- PARTITION BY Bin Ä‘á»ƒ random riÃªng cho má»—i BIN
- Sá»­ dá»¥ng index idx_cdata_bin_status cho WHERE clause
- Thá»i gian: <2s cho 100 BINs Ã— 50 cards = 5,000 cards

3.5. Check Duplicates Query
Má»¥c Ä‘Ã­ch: Kiá»ƒm tra PAN cÃ³ tá»“n táº¡i trong database khÃ´ng

Strategy 1 (Temp Table):
CREATE TEMP TABLE tmp_pans (pan TEXT PRIMARY KEY);
INSERT INTO tmp_pans (pan) VALUES (?), (?), ...; -- Max 100 values per INSERT
SELECT c.pan FROM cdata c INNER JOIN tmp_pans t ON c.pan = t.pan;

Giáº£i thÃ­ch:
- Sá»­ dá»¥ng TEMP TABLE Ä‘á»ƒ trÃ¡nh vÆ°á»£t quÃ¡ 100 parameters limit cá»§a D1
- INSERT multi-value (100 values) thay vÃ¬ 100 INSERT statements
- JOIN query duy nháº¥t thay vÃ¬ nhiá»u IN queries
- Thá»i gian: <1s cho 10k PANs

Strategy 2 (Fallback - IN clause):
SELECT pan FROM cdata WHERE pan IN (?, ?, ...) -- Max 100 parameters

Giáº£i thÃ­ch:
- Fallback khi TEMP TABLE khÃ´ng hoáº¡t Ä‘á»™ng
- Chunk 100 PANs má»—i query
- Thá»i gian: <2s cho 10k PANs

3.6. Import Cards Query
Má»¥c Ä‘Ã­ch: Insert nhiá»u cards vÃ o database

Query:
INSERT OR IGNORE INTO cdata (pan, mm, yy, cvv, Bin, last4, info, status) 
VALUES (?, ?, ?, ?, ?, ?, ?, 'unknown'), (?, ?, ?, ?, ?, ?, ?, 'unknown'), ...

Giáº£i thÃ­ch:
- Multi-value INSERT: 12 cards Ã— 8 params = 96 params (dÆ°á»›i 100 limit)
- INSERT OR IGNORE Ä‘á»ƒ skip duplicates
- KhÃ´ng dÃ¹ng TEMP TABLE Ä‘á»ƒ trÃ¡nh SQLITE_AUTH error
- Thá»i gian: ~100ms cho 12 cards

3.7. Update Stats Query (Delta Update)
Má»¥c Ä‘Ã­ch: Cáº­p nháº­t stats cho BINs bá»‹ áº£nh hÆ°á»Ÿng sau import

Query 1 (Calculate stats):
SELECT c.Bin, COUNT(*) as total_cards,
  SUM(CASE WHEN c.status='1' THEN 1 ELSE 0 END) as live_cards,
  SUM(CASE WHEN c.status='2' THEN 1 ELSE 0 END) as ct_cards,
  SUM(CASE WHEN c.status='0' THEN 1 ELSE 0 END) as die_cards,
  SUM(CASE WHEN c.status='unknown' THEN 1 ELSE 0 END) as unknown_cards
FROM cdata c
WHERE c.Bin IN (?, ?, ...) -- 50 BINs per batch
GROUP BY c.Bin

Query 2 (Update bin_inventory):
INSERT INTO bin_inventory (...) VALUES (?, ?, ...)
ON CONFLICT(Bin) DO UPDATE SET 
  total_cards=excluded.total_cards,
  live_cards=excluded.live_cards,
  ...

Giáº£i thÃ­ch:
- Delta update: chá»‰ update BINs bá»‹ áº£nh hÆ°á»Ÿng, khÃ´ng rebuild toÃ n bá»™
- Batch 50 BINs má»—i láº§n Ä‘á»ƒ trÃ¡nh quÃ¡ táº£i
- Sá»­ dá»¥ng ON CONFLICT DO UPDATE Ä‘á»ƒ upsert
- Thá»i gian: ~500ms cho 50 BINs

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
4. LUá»’NG Dá»® LIá»†U THá»°C THI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

4.1. Dashboard
Luá»“ng:
1. User má»Ÿ Dashboard tab
2. Frontend gá»i GET /api/dashboard
3. Router kiá»ƒm tra cache (TTL: 3600s)
4. Náº¿u cache hit â†’ tráº£ vá» ngay
5. Náº¿u cache miss:
   - Gá»i db.getDashboardStats()
   - Query 7 queries song song tá»« bin_inventory:
     * Total cards & records
     * Status aggregation (live, die)
     * Top 10 BINs
     * Top 10 Brands
     * Top 10 Types
     * Top 10 Categories
     * Top 10 Countries
   - LÆ°u vÃ o cache
   - Tráº£ vá» JSON
6. Frontend render cards vÃ  charts

Má»¥c Ä‘Ã­ch:
- Hiá»ƒn thá»‹ thá»‘ng kÃª tá»•ng quan real-time
- Query tá»« pre-aggregated tables (nhanh)
- Cache Ä‘á»ƒ giáº£m load database

4.2. BIN Checker (Search)
Luá»“ng:
1. User nháº­p BINs hoáº·c chá»n filters
2. Frontend gá»i GET /api/bin?bin=...&brand=...&...
3. Router kiá»ƒm tra cache (TTL: 300s)
4. Náº¿u cache miss:
   - Gá»i db.searchBIN(params)
   - Query tá»« BIN_Data vá»›i WHERE Ä‘á»™ng
   - Pagination vá»›i LIMIT/OFFSET
   - Tráº£ vá» {data, total}
5. Frontend hiá»ƒn thá»‹ table vá»›i pagination

Má»¥c Ä‘Ã­ch:
- Tra cá»©u BIN metadata tá»« 400k BINs
- Filter Ä‘á»™ng theo nhiá»u tiÃªu chÃ­
- Pagination Ä‘á»ƒ xá»­ lÃ½ káº¿t quáº£ lá»›n

4.3. Card Exporter
Luá»“ng:
1. User chá»n filters (Brand, Type, Category, Country, Issuer, Min Cards, Status)
2. Frontend gá»i POST /api/search-bins vá»›i filters
3. Router gá»i db.searchBins(params)
4. Query tá»« bin_inventory vá»›i WHERE Ä‘á»™ng
5. Tráº£ vá» danh sÃ¡ch BINs match
6. Frontend hiá»ƒn thá»‹ preview table
7. User click "Export All"
8. Frontend gá»i POST /api/export-cards vá»›i bins array
9. Router gá»i db.exportCards(params)
10. Query tá»« cdata vá»›i CTE vÃ  RANDOM():
    - ROW_NUMBER() OVER (PARTITION BY Bin ORDER BY RANDOM())
    - Filter theo status
    - Limit cards per BIN
11. Format output: "# BIN: xxx\ncard1\ncard2\n\n# BIN: yyy\n..."
12. Tráº£ vá» cards array
13. Frontend hiá»ƒn thá»‹ trong textarea vá»›i progress bar

Má»¥c Ä‘Ã­ch:
- Export cards theo filter Ä‘á»™ng
- Random selection Ä‘á»ƒ trÃ¡nh bias
- Batch processing Ä‘á»ƒ xá»­ lÃ½ nhiá»u BINs

4.4. Normalize Cards
Luá»“ng:
1. User paste cards vÃ o textarea
2. Frontend gá»i POST /api/normalize vá»›i {cards, filterExpired}
3. Router gá»i CardUtils.normalizeAll(cards, filterExpired)
4. CardUtils.normalize() cho má»—i line:
   - Parse format (|, /, ,, space)
   - Validate PAN (13-19 digits, Luhn check)
   - Validate mm (01-12), yy (2 digits), cvv (3-4 digits)
   - Check expired náº¿u filterExpired=true
   - Return normalized format: pan|mm|yy|cvv
5. Tráº£ vá» {valid, errors}
6. Frontend hiá»ƒn thá»‹ valid cards vÃ  errors

Má»¥c Ä‘Ã­ch:
- Chuáº©n hÃ³a format cards tá»« nhiá»u format khÃ¡c nhau
- Validate PAN vá»›i Luhn algorithm
- Filter expired cards

4.5. Check Duplicates
Luá»“ng:
1. User paste cards vÃ o textarea
2. Frontend extract PANs tá»« cards
3. Frontend gá»i POST /api/check-duplicates vá»›i {cards}
4. Router extract PANs tá»« cards
5. Router gá»i db.checkDuplicates(pans)
6. DatabaseService:
   - Táº¡o TEMP TABLE tmp_pans
   - INSERT PANs vÃ o tmp_pans (100 values per INSERT)
   - JOIN query: SELECT c.pan FROM cdata c INNER JOIN tmp_pans t ON c.pan = t.pan
   - Fallback: IN clause vá»›i chunks 100 náº¿u TEMP TABLE fail
7. Tráº£ vá» {unique, duplicates}
8. Frontend hiá»ƒn thá»‹ unique cards vÃ  duplicates vá»›i progress bar

Má»¥c Ä‘Ã­ch:
- Kiá»ƒm tra PAN cÃ³ tá»“n táº¡i trong database khÃ´ng
- Sá»­ dá»¥ng TEMP TABLE Ä‘á»ƒ trÃ¡nh 100 parameters limit
- Batch processing Ä‘á»ƒ xá»­ lÃ½ nhiá»u cards

4.6. Import Cards (QUAN TRá»ŒNG - ÄÃƒ Tá»I Æ¯U)
Luá»“ng:
1. User paste cards hoáº·c upload file.txt
2. Frontend gá»i POST /api/import vá»›i {cards} (batch 1000 cards)
3. Router gá»i CardUtils.normalizeAll(cards)
4. Router gá»i db.importCards(normalized.valid)
5. DatabaseService.importCards():
   
   Phase 1: Insert Cards (Direct Insert)
   - Loop: 12 cards per INSERT (96 parameters, dÆ°á»›i 100 limit)
   - INSERT OR IGNORE INTO cdata VALUES (12 cards)
   - Track affected BINs trong Set
   - KhÃ´ng dÃ¹ng TEMP TABLE Ä‘á»ƒ trÃ¡nh SQLITE_AUTH error
   
   Phase 2: Update Stats (Delta Update)
   - Batch 50 BINs má»—i láº§n
   - Query metadata tá»« BIN_Data (batch query)
   - Calculate stats tá»« cdata (GROUP BY Bin)
   - Update bin_inventory (ON CONFLICT DO UPDATE)
   - Update country_stats (aggregate tá»« bin_inventory)
   
6. Clear cache (dashboard, stats, card-stats, search)
7. Tráº£ vá» {imported, skipped, errors}
8. Frontend hiá»ƒn thá»‹ progress bar vÃ  stats

Má»¥c Ä‘Ã­ch:
- Import cards vÃ o database
- Delta update stats thay vÃ¬ full rebuild
- Batch processing Ä‘á»ƒ tá»‘i Æ°u performance

Táº¡i sao sá»­ dá»¥ng cÃ¡ch hiá»‡n táº¡i:
1. Direct INSERT (khÃ´ng dÃ¹ng TEMP TABLE):
   - SQLITE_AUTH error khi dÃ¹ng TEMP TABLE vá»›i db.batch() lá»›n
   - Multi-value INSERT (12 cards) nhanh hÆ¡n 12 INSERT riÃªng láº»
   - 96 parameters (dÆ°á»›i 100 limit) an toÃ n

2. Delta Update (khÃ´ng full rebuild):
   - Full rebuild: DELETE + INSERT toÃ n bá»™ bin_inventory (cháº­m, ~30s)
   - Delta update: chá»‰ update BINs bá»‹ áº£nh hÆ°á»Ÿng (nhanh, ~500ms cho 50 BINs)
   - Batch 50 BINs Ä‘á»ƒ trÃ¡nh quÃ¡ táº£i

3. Batch Metadata Query:
   - Query metadata cho 50 BINs má»™t láº§n thay vÃ¬ 50 queries riÃªng
   - Giáº£m sá»‘ lÆ°á»£ng queries tá»« O(n) xuá»‘ng O(n/50)

4. Sequential Processing:
   - Insert cards trÆ°á»›c, update stats sau
   - TrÃ¡nh deadlock vÃ  transaction conflicts
   - Dá»… debug vÃ  rollback

Váº«n cÃ²n cháº­m vÃ¬:
- Cloudflare D1 cÃ³ giá»›i háº¡n: 100 parameters/query, transaction timeout
- Má»—i INSERT 12 cards váº«n pháº£i chá» response
- Stats update pháº£i query láº¡i tá»« cdata (khÃ´ng thá»ƒ cache)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
5. ÄIá»‚M Cáº¦N LÆ¯U Ã
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

5.1. Cloudflare D1 Limitations
- 100 parameters per query: Pháº£i chunk queries
- SQLITE_AUTH error: KhÃ´ng dÃ¹ng TEMP TABLE vá»›i batch lá»›n
- Transaction timeout: KhÃ´ng dÃ¹ng transaction quÃ¡ lÃ¢u
- Read-only trong má»™t sá»‘ trÆ°á»ng há»£p: Pháº£i retry

5.2. Cache Strategy
- Dashboard: 3600s (1 hour) - Data thay Ä‘á»•i Ã­t
- Filters: 21600s (6 hours) - Data Ã­t thay Ä‘á»•i
- Search: 300s (5 minutes) - Data thay Ä‘á»•i thÆ°á»ng xuyÃªn
- Card Stats: 300s (5 minutes) - Data thay Ä‘á»•i thÆ°á»ng xuyÃªn

5.3. Index Strategy
- Composite indexes cho filter queries
- Single indexes cho unique lookups
- DESC index cho Top N queries
- KhÃ´ng over-index: Chá»‰ index cáº§n thiáº¿t

5.4. Denormalization
- bin_inventory denormalized tá»« BIN_Data Ä‘á»ƒ trÃ¡nh JOIN
- Metadata Ä‘Æ°á»£c copy Ä‘á»ƒ query nhanh
- Trade-off: Storage vs Performance

5.5. Pre-aggregation
- bin_inventory: Pre-aggregated stats tá»« cdata
- country_stats: Pre-aggregated stats tá»« bin_inventory
- Trade-off: Storage vs Query Speed

5.6. Validation
- PAN: Luhn algorithm check
- PAN length: 13-19 digits
- Date format: mm (01-12), yy (2 digits)
- CVV: 3-4 digits

5.7. Error Handling
- Try-catch cho má»i database operations
- Fallback strategies (TEMP TABLE â†’ IN clause)
- Retry logic cho transient errors
- User-friendly error messages

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
6. TÃNH NÄ‚NG Äá»ŒC/GHI DATABASE Sá» HÃ€NG Lá»šN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

6.1. Import Cards (10M rows)
Giáº£i phÃ¡p Ä‘Ã£ triá»ƒn khai:
1. Multi-value INSERT: 12 cards per INSERT (96 params)
2. Direct INSERT: KhÃ´ng dÃ¹ng TEMP TABLE
3. Delta Update: Chá»‰ update BINs bá»‹ áº£nh hÆ°á»Ÿng
4. Batch Metadata Query: 50 BINs per query
5. Sequential Processing: Insert â†’ Update stats

Táº¡i sao cháº­m:
- D1 limit: 100 params/query â†’ chá»‰ insert 12 cards má»—i láº§n
- Network latency: Má»—i INSERT pháº£i chá» response
- Stats update: Pháº£i query láº¡i tá»« cdata (khÃ´ng cache Ä‘Æ°á»£c)

Táº¡i sao khÃ´ng dÃ¹ng cÃ¡ch khÃ¡c:
- TEMP TABLE: SQLITE_AUTH error vá»›i batch lá»›n
- Full rebuild: QuÃ¡ cháº­m (30s+) vÃ  lock database
- Parallel INSERT: D1 khÃ´ng support concurrent writes tá»‘t

6.2. Check Duplicates (10k+ PANs)
Giáº£i phÃ¡p Ä‘Ã£ triá»ƒn khai:
1. TEMP TABLE strategy: INSERT 100 PANs per query
2. Single JOIN query: Thay vÃ¬ nhiá»u IN queries
3. Fallback: IN clause vá»›i chunks 100 náº¿u TEMP TABLE fail

Táº¡i sao nhanh:
- TEMP TABLE: Index tá»± Ä‘á»™ng, JOIN nhanh
- Batch INSERT: 100 PANs per INSERT
- Single query: Thay vÃ¬ 100 queries

6.3. Export Cards (100 BINs Ã— 50 cards = 5k cards)
Giáº£i phÃ¡p Ä‘Ã£ triá»ƒn khai:
1. CTE vá»›i ROW_NUMBER(): Random selection per BIN
2. Index idx_cdata_bin_status: Fast WHERE clause
3. Batch processing: Process 10 BINs per batch

Táº¡i sao nhanh:
- Index: Fast lookup by Bin and status
- CTE: Efficient random selection
- Batch: KhÃ´ng load táº¥t cáº£ vÃ o memory

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
7. Káº¾T LUáº¬N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Há»‡ thá»‘ng Ä‘Ã£ Ä‘Æ°á»£c tá»‘i Æ°u vá»›i:
- Pre-aggregation: bin_inventory, country_stats
- Denormalization: Metadata trong bin_inventory
- Strategic indexing: Composite indexes cho filter queries
- Delta update: Chá»‰ update BINs bá»‹ áº£nh hÆ°á»Ÿng
- Cache strategy: TTL phÃ¹ há»£p cho tá»«ng loáº¡i data
- Batch processing: Chunk queries Ä‘á»ƒ trÃ¡nh D1 limits

Váº«n cÃ²n Ä‘iá»ƒm cáº§n cáº£i thiá»‡n:
- Import speed: Bá»‹ giá»›i háº¡n bá»Ÿi D1 (100 params/query)
- Stats update: Pháº£i query láº¡i tá»« cdata (khÃ´ng cache Ä‘Æ°á»£c)

